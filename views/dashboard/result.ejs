<%- include("../partials/header") %>

<main class="content">
  <div class="container-fluid p-0">

    <h1 class="h3 mb-3">Results</h1>

    <div class="row">
      <div class="col-md-6 col-lg-4  col-xxl-4">
        <div class="card">
          <div class="card-header">
            <div class="input-group">
              <select name="term" id="term" class="form-select">
                <option disabled selected hidden>Select a Term</option>
                <% academicYears.forEach((year) => { %>
                <optgroup label="<%= year.year %>">
                  <% year.Terms.forEach((term) => { %>
                  <option value="<%= term.id %>" <%= selectedTerm === term.id ? "selected" : "" %>><%= term.name %></option>
                  <% }) %>
                </optgroup>
                <% }) %>
              </select>
            </div>
            <% if(selectedTerm) { %>
            <% if(results.length > 0) { %>
            <div class="mt-3">
              <button id="printReport" class="btn btn-success" type="button">Print</button>
            </div>
            <% } %>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12" id="printableArea">
        <div class="card pt-4">
          <div class="card-body h-100">
            <% if(selectedTerm) { %>
            <% if(results.length > 0) { %>
            <div class="container text-center mb-4 mb w-full">
              <!-- School Logo and Name -->
              <div class="d-flex align-items-center justify-content-center">
                <img src="/img/logo/icon.png" alt="School Logo" class="rounded-circle border border-secondary me-3" width="90" height="90">
                <div>
                  <h2 class="fw-bold text-uppercase text-primary school-title text-4xl">Diamond Secondary School Nkpor</h2>
                  <p class="text-primary m-0">No. 7 Ernest Odili Crescent Nkpor-Agu, Anambra State.</p>
                  <p class="fst-italic text-secondary">Motto: <span class="fw-semibold">Knowledge, Discipline and Services</span></p>
                </div>
              </div>

              <!-- Terminal Report Sheet Badge -->
              <div class="terminal-report-sheet mt-1 mb-">
                <span class="badge bg-dark text-white px-3 py-2">Terminal Report Sheet</span>
              </div>
            </div>
            <div class="d-flex flex-wrap gap-3 mb-3">
              <p><b>NAME:</b> <span class="border border-2 p-1 px-3"><%= student.firstName %> <%= student.middleName %> <%= student.lastName %></span></p>
              <p><b>CLASS:</b> <span class="border border-2 p-1 px-3"><%= student.class.name %></span></p>
              <p><b>TERM:</b> <span class="border border-2 p-1 px-3"><%= term.name %></span></p>
              <p><b>YEAR:</b> <span class="border border-2 p-1 px-3"><%= academicYear.year %></span></p>
              <p><b>TOTAL:</b> <span class="border border-2 p-1 px-3"><%= studentTermPerformance.totalScore %></span></p>
              <p><b>AVERAGE:</b> <span class="border border-2 p-1 px-3"><%= studentTermPerformance.averageScore %></span></p>
              <p><b>POSITION:</b> <span class="border border-2 p-1 px-3"><%= studentTermPerformance.position %></span></p>
              <p><b>OUT OF:</b> <span class="border border-2 p-1 px-3"><%= outOf %></span></p>
              <p><b>REMARK:</b> <span class="border border-2 p-1 px-3"><%= studentTermPerformance.overallRemark %></span></p>
            </div>
            <div class="custom-table-responsive table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>No</th>
                    <th class="subject-col">Subjects</th>
                    <th>First Test (10)</th>
                    <th>Presentation (5)</th>
                    <th>Mid-term test (10)</th>
                    <th>Project (10)</th>
                    <th>Note (5)</th>
                    <th>Exam score (60)</th>
                    <th>Total score (100)</th>
                    <th>Grade</th>
                    <th>Position</th>
                    <!-- <th>Class average</th> -->
                    <th>Class lowest score</th>
                    <th>Class highest score</th>
                    <th>Remark</th>
                  </tr>
                </thead>
                <tbody>
                  <% results.map((result, index) => { %>
                  <tr>
                    <td><%= ++index %></td>
                    <td class="subject-col"><%= result.Subject ? result.Subject.name : "N/A" %></td>
                    <td><%= result.firstTest %></td>
                    <td><%= result.presentation %></td>
                    <td><%= result.midTermTest %></td>
                    <td><%= result.project %></td>
                    <td><%= result.note %></td>
                    <td><%= result.examScore %></td>
                    <td><%= result.totalScore %></td>
                    <td><%= result.grade %></td>
                    <td><%= result.position %></td>
                    <!-- <td><%= result.dataValues.classStats.classAverage %></td> -->
                    <td><%= result.dataValues.classStats.classLowest %></td>
                    <td><%= result.dataValues.classStats.classHighest %></td>
                    <td><%= result.remark %></td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <div class="d-flex align-items-center * justify-content-between">
              <p class="pt-3"><b>TEACHER'S REMARK:</b> <span class="border border-2 p-1 px-3"><%= studentTermPerformance.teachersRemark %></span></p>
              <div class="d-flex flex-col flex-column align-items-center gap-">
                <img src="/img/photos/signature.png" alt="Signature" class="img-fluid mb-2" width="100" height="100">
                <b class="border-top border-2 border-secondary px-3">SIGNED MANAGEMENT.</b>
              </div>
            </div>
            <% } else { %>
            <p class="text-center">No Results found</p>
            <% } %>
            <% } else { %>
            <p class="text-center">Please select a term to continue</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>


  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const select = document.getElementById("term");

    select.addEventListener("change", function() {
      const selectedTermId = this.value;
      let currentUrl = new URL(window.location.href);

      currentUrl.searchParams.set("term", selectedTermId);
      window.location.href = currentUrl.toString();

    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const select = document.getElementById("term");
    const printButton = document.getElementById("printReport");

    select.addEventListener("change", function() {
      const selectedTermId = this.value;
      let currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set("term", selectedTermId);
      window.location.href = currentUrl.toString();
    });

    function printReport() {
      const printableArea = document.getElementById("printableArea").innerHTML;
      const originalContent = document.body.innerHTML;
      const tableContainer = document.querySelector(".custom-table-responsive");

      if (tableContainer) {
        tableContainer.classList.remove("custom-table-responsive");
      }

      const printContent = `
        <style>
          @font-face {
            font-family: 'AntonLocal';
            src: url('/fonts/AntonLocal.woff2') format('woff2'),
                 url('/fonts/AntonLocal.woff') format('woff');
            font-weight: normal;
            font-style: normal;
          }
          @media print {
            @page { size: A4; margin: 5mm; }
            body { width: 100%; height: 100%; font-size: 10px; overflow: visible !important; background-color: white }
            html, body { overflow: visible !important; }
            .school-title { font-family: 'AntonLocal', Impact, Charcoal, sans-serif !important; font-size: 2em !important; white-space: nowrap !important; margin: 0 !important; padding: 0 !important; }
            table { width: 100% !important; font-size: 18px !important; border-collapse: collapse !important; }
            th, td { padding: 4px !important; font-size: 12px !important; vertical-align: top !important; }
            thead th { font-size: 10px !important; }
            .table-responsive { all: unset; height: auto !important; overflow: visible !important; }
            p { margin: 0 !important; padding: 0 !important; }
            img { width: 50px !important; height: 50px !important; }
            .terminal-report-sheet {margin-bottom: 2em; margin-top: 4em}
          }
        </style>
        ${printableArea}
      `;

      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      window.location.reload();
    }

    printButton.addEventListener("click", printReport);

    document.addEventListener("keydown", function(event) {
      if ((event.ctrlKey || event.metaKey) && event.key === "p") {
        printReport();
      }
    });
  });
</script>

<style>
  .school-title {
    font-family: 'AntonLocal', Impact, Charcoal, sans-serif !important;
    font-size: 2em !important;
    white-space: nowrap !important;
    margin: 0 !important;
    padding: 0 !important;
  }
</style>

<%- include("../partials/footer") %>